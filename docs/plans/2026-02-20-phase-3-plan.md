# Phase 3: Polish, Accessibility & Deploy — Implementation Plan

> **STATUS: COMPLETE** — Merged to main 2026-02-20 (commit ce42010). All 12 tasks executed, all 12 commits merged.

**Goal:** Ship the nylon site to GitHub Pages with proper SEO, accessibility compliance, and production polish.

**Architecture:** No new components. This phase patches existing files: HTML meta, accessibility attributes, focus management, font preloading, and adds a GitHub Actions deploy pipeline. All changes are surgical edits to existing code.

**Tech Stack:** Vite 7, React 19, TypeScript 5.9, Tailwind CSS 4, GitHub Actions (actions/deploy-pages@v4)

**Reference:** Deploy pipeline modeled on `/home/scipio/projects/the-lin/.github/workflows/deploy.yml`

---

## Batch 1: HTML, SEO & Public Assets (Tasks 1–3)

### Task 1: Fix index.html — Language, Title, Meta Tags, OG

**Files:**
- Modify: `index.html`

**Why:** Current `index.html` has `lang="en"` (should be `zh-TW`), title is `nylon-phase-0-1`, no description, no OG tags, no Twitter card, references a non-existent `vite.svg` favicon.

**Step 1: Replace index.html content**

```html
<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>鄭南榕 — 紙上死刑 | Nylon Deng Interactive Experience</title>
    <meta name="description" content="一個讓民眾「體感」戒嚴後言論恐怖的沉浸式網站。透過5000頁監控檔案和「唯一死刑」法條，讓訪客理解：解嚴之後，發表文字仍然可以被判死刑。" />
    <meta name="theme-color" content="#0A0F0A" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="鄭南榕 — 紙上死刑" />
    <meta property="og:description" content="解嚴之後，發表文字仍然可以被判死刑。一個關於言論自由、國家監控與「唯一死刑」的沉浸式互動體驗。" />
    <meta property="og:image" content="/nylon/og-image.png" />
    <meta property="og:url" content="https://scip.io/nylon/" />
    <meta property="og:locale" content="zh_TW" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="鄭南榕 — 紙上死刑" />
    <meta name="twitter:description" content="解嚴之後，發表文字仍然可以被判死刑。" />
    <meta name="twitter:image" content="/nylon/og-image.png" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/nylon/favicon.svg" />

    <!-- Font Preloads (critical CJK fonts) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;700&family=LXGW+WenKai+TC&display=swap" />
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

**Step 2: Verify build**

Run: `npm run build`
Expected: PASS (no HTML parse errors)

**Step 3: Commit**

```bash
git add index.html
git commit -m "feat: add SEO meta tags, OG/Twitter cards, font preloads to index.html"
```

---

### Task 2: Create Favicon & OG Image Placeholder

**Files:**
- Create: `public/favicon.svg`
- Create: `public/og-image.png` (1200x630 placeholder via ImageMagick)

**Why:** favicon.svg needs to exist for the link tag. OG image is referenced in meta tags. Both must live in `public/` so Vite copies them to dist at build time.

**Step 1: Create public/ directory and favicon.svg**

```bash
mkdir -p /home/scipio/projects/nylon/public
```

Write `public/favicon.svg`:
```svg
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
  <rect width="32" height="32" rx="4" fill="#0A0F0A"/>
  <text x="16" y="23" text-anchor="middle" font-family="serif" font-size="20" font-weight="bold" fill="#E8DCC4">鄭</text>
</svg>
```

**Step 2: Generate OG image placeholder**

```bash
convert -size 1200x630 xc:'#0A0F0A' \
  -font "Noto-Serif-CJK-TC" -pointsize 72 -fill '#E8DCC4' \
  -gravity center -annotate +0-60 '鄭南榕' \
  -pointsize 36 -fill '#9D9892' \
  -annotate +0+40 '紙上死刑 — 沉浸式互動體驗' \
  -pointsize 18 -fill '#4A6741' \
  -annotate +0+110 '1947–1989' \
  /home/scipio/projects/nylon/public/og-image.png
```

If font not available, use a simpler fallback:
```bash
convert -size 1200x630 xc:'#0A0F0A' \
  -fill '#4A6741' -draw "rectangle 0,0 1200,3" \
  -fill '#4A6741' -draw "rectangle 0,627 1200,630" \
  /home/scipio/projects/nylon/public/og-image.png
```

**Step 3: Verify build includes public assets**

Run: `npm run build && ls dist/favicon.svg dist/og-image.png`
Expected: Both files present in `dist/`

**Step 4: Commit**

```bash
git add public/
git commit -m "feat: add favicon.svg and OG image placeholder"
```

---

### Task 3: Fix package.json Name & Add 404.html for SPA Routing

**Files:**
- Modify: `package.json` (line 2: name field)
- Create: `public/404.html`

**Why:** package.json name is `nylon-phase-0-1` — should be `nylon`. GitHub Pages needs a 404.html that redirects to index.html for SPA client-side routing (otherwise refreshing on a scroll position would 404).

**Step 1: Update package.json name**

Change `"name": "nylon-phase-0-1"` to `"name": "nylon"`.

**Step 2: Create 404.html for GitHub Pages SPA redirect**

Write `public/404.html`:
```html
<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>鄭南榕 — 紙上死刑</title>
    <script>
      // GitHub Pages SPA redirect
      // Redirects 404s back to index.html preserving the path
      var pathSegmentsToKeep = 1; // /nylon/ = 1 segment
      var l = window.location;
      l.replace(
        l.protocol + '//' + l.hostname + (l.port ? ':' + l.port : '') +
        l.pathname.split('/').slice(0, 1 + pathSegmentsToKeep).join('/') + '/?/' +
        l.pathname.slice(1).split('/').slice(pathSegmentsToKeep).join('/').replace(/&/g, '~and~') +
        (l.search ? '&' + l.search.slice(1).replace(/&/g, '~and~') : '') +
        l.hash
      );
    </script>
  </head>
  <body></body>
</html>
```

**Step 3: Verify build**

Run: `npm run build && ls dist/404.html`
Expected: File present

**Step 4: Commit**

```bash
git add package.json public/404.html
git commit -m "chore: fix package name, add 404.html for GitHub Pages SPA routing"
```

---

## Batch 2: Accessibility (Tasks 4–7)

### Task 4: Add Skip-to-Content Link & Landmark Roles

**Files:**
- Modify: `src/App.tsx`

**Why:** Screen reader users need a skip-to-content link to bypass the navigation. The `<main>` element should have a label for assistive technology.

**Step 1: Add skip link and aria-label to main**

In `App.tsx`, add a visually-hidden skip link as the first child of `<>`, before `<Navigation>`:

```tsx
{/* Skip to content link for screen readers */}
<a
  href="#prologue"
  className="fixed top-0 left-0 z-[9999] -translate-y-full bg-void px-4 py-2 font-document text-sm text-crt-green transition-transform focus:translate-y-0"
>
  跳至主要內容
</a>
```

Add `aria-label="主要內容"` to `<main>`.

**Step 2: Verify build**

Run: `npm run build`
Expected: PASS

**Step 3: Commit**

```bash
git add src/App.tsx
git commit -m "feat: add skip-to-content link and main landmark label"
```

---

### Task 5: Focus Trap for CRT Modal

**Files:**
- Modify: `src/components/crt/CRTOverlay.tsx`

**Why:** When the CRT modal is open, Tab key can escape to background elements. WCAG 2.1 requires focus to be trapped inside open modals and restored on close.

**Step 1: Add focus trap logic**

Add a `useEffect` that:
1. On `phase === 'ready'`: stores `document.activeElement` as previous focus, then focuses the close button
2. On Tab keydown: cycles focus within the modal container
3. On close (phase becomes 'closed'): restores previous focus

```tsx
// Focus trap — keep Tab cycling within the modal
useEffect(() => {
  if (phase !== 'ready') return

  const previousFocus = document.activeElement as HTMLElement | null
  const modal = modalRef.current
  if (!modal) return

  // Focus the close button on open
  const closeBtn = modal.querySelector<HTMLElement>('button[aria-label="關閉"]')
  closeBtn?.focus()

  const handleTab = (e: KeyboardEvent) => {
    if (e.key !== 'Tab') return
    const focusable = modal.querySelectorAll<HTMLElement>(
      'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
    )
    if (focusable.length === 0) return
    const first = focusable[0]
    const last = focusable[focusable.length - 1]
    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault()
      last.focus()
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault()
      first.focus()
    }
  }

  window.addEventListener('keydown', handleTab)
  return () => {
    window.removeEventListener('keydown', handleTab)
    previousFocus?.focus()
  }
}, [phase])
```

Also add a `ref` to the modal container div:
```tsx
const modalRef = useRef<HTMLDivElement>(null)
```

And attach `ref={modalRef}` to the outer `role="dialog"` div.

**Step 2: Verify build**

Run: `npm run build`
Expected: PASS

**Step 3: Commit**

```bash
git add src/components/crt/CRTOverlay.tsx
git commit -m "feat: add focus trap to CRT modal overlay"
```

---

### Task 6: Navigation Backdrop Keyboard Support & Focus Management

**Files:**
- Modify: `src/components/layout/Navigation.tsx`

**Why:** The backdrop `<div>` uses `onClick` but has no keyboard handler — screen readers can't dismiss it. Focus should move into the menu panel when opened.

**Step 1: Add keyboard handler to backdrop**

Replace the backdrop `<div>` click handler:
```tsx
<div
  className="absolute inset-0 bg-void/80 backdrop-blur-[2px]"
  onClick={() => setIsMenuOpen(false)}
  onKeyDown={(e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault()
      setIsMenuOpen(false)
    }
  }}
  role="button"
  tabIndex={-1}
  aria-label="關閉目錄"
/>
```

**Step 2: Auto-focus first menu item when menu opens**

Add a ref to the first nav button and focus it when menu opens:

```tsx
const firstNavRef = useRef<HTMLButtonElement>(null)

useEffect(() => {
  if (isMenuOpen) {
    // Small delay to let slide animation start
    const timer = setTimeout(() => firstNavRef.current?.focus(), 200)
    return () => clearTimeout(timer)
  }
}, [isMenuOpen])
```

Attach `ref={firstNavRef}` to the first button in the chapter list (when `index === 0`).

**Step 3: Verify build**

Run: `npm run build`
Expected: PASS

**Step 4: Commit**

```bash
git add src/components/layout/Navigation.tsx
git commit -m "feat: add keyboard support for nav backdrop and auto-focus on menu open"
```

---

### Task 7: Aria Improvements Across Interactive Components

**Files:**
- Modify: `src/components/interactive/BurntEdgeCard.tsx`
- Modify: `src/components/interactive/StampAnimation.tsx`
- Modify: `src/chapters/ContentWarning.tsx`
- Modify: `src/chapters/Prologue.tsx`

**Why:** Several components need small aria attribute improvements:
- BurntEdgeCard button needs `aria-controls` linking to the expanded content
- StampAnimation should announce stamp result to screen readers
- ContentWarning enter button needs descriptive aria-label
- Prologue pixel art scene needs better alt text structure

**Step 1: BurntEdgeCard — add aria-controls and id to expandable content**

In `BurntEdgeCard.tsx`, generate an id from title:
```tsx
const contentId = `burnt-card-${title.replace(/\s+/g, '-')}`
```

Add `aria-controls={contentId}` to the `<button>`.
Add `id={contentId}` and `role="region"` to the expandable `<div>`.

**Step 2: StampAnimation — add aria-live for stamp result**

In `StampAnimation.tsx`, add `aria-live="assertive"` to the stamp `<span>` so screen readers announce when the stamp appears.

**Step 3: ContentWarning — add descriptive aria-label**

On the enter button in `ContentWarning.tsx`, add:
```tsx
aria-label="確認並進入：內容涉及政治迫害與自焚事件"
```

**Step 4: Prologue — add lang attribute to Chinese quote**

The `blockquote` in `Prologue.tsx` should have `lang="zh-TW"` for screen readers that might try to read it in English:
```tsx
<blockquote lang="zh-TW" className="...">
```

**Step 5: Verify build**

Run: `npm run build`
Expected: PASS

**Step 6: Commit**

```bash
git add src/components/interactive/BurntEdgeCard.tsx src/components/interactive/StampAnimation.tsx src/chapters/ContentWarning.tsx src/chapters/Prologue.tsx
git commit -m "feat: aria improvements across interactive components and chapters"
```

---

## Batch 3: Performance & Font Loading (Tasks 8–9)

### Task 8: Verify Font Loading Strategy & Add font-display

**Files:**
- Modify: `src/index.css`

**Why:** Google Fonts link in index.html uses `display=swap` (good). But we should add `@font-face` fallback declarations with `font-display: swap` in CSS for any locally-hosted fonts and add `contain: content` to heavy animation elements.

**Step 1: Add font-display declarations and containment**

In `src/index.css`, after the `@theme` block, add:

```css
/* === Font Display Fallbacks === */
/* Google Fonts already uses display=swap via link tag.
   These ensure local font references also swap correctly. */
@font-face {
  font-family: "LXGW WenKai TC";
  font-display: swap;
  src: local("LXGW WenKai TC");
}

/* === Layout Containment for Performance === */
.scroll-snap-container > * {
  contain: layout style;
}
```

**Step 2: Verify build**

Run: `npm run build`
Expected: PASS

**Step 3: Commit**

```bash
git add src/index.css
git commit -m "perf: add font-display swap fallbacks and layout containment"
```

---

### Task 9: Lighthouse Audit & Fix Critical Issues

**Files:**
- Possibly modify: `index.html`, `src/index.css`, various components

**Why:** Target Lighthouse 90+ on all metrics. This task is investigative — run Lighthouse, identify issues, fix them.

**Step 1: Build and serve locally**

```bash
npm run build && npx serve dist -l 4173
```

**Step 2: Run Lighthouse CLI**

```bash
npx lighthouse http://localhost:4173/nylon/ --output=json --output-path=./lighthouse-report.json --chrome-flags="--headless --no-sandbox"
```

**Step 3: Review scores and fix**

Common fixes:
- If **Performance < 90**: Check for render-blocking resources, unoptimized images, excessive DOM size
- If **Accessibility < 90**: Missing alt text, low contrast ratios, missing form labels
- If **Best Practices < 90**: Console errors, deprecated APIs, missing HTTPS
- If **SEO < 90**: Missing meta description (already added in Task 1), missing robots.txt

**Step 4: Create robots.txt if missing**

Write `public/robots.txt`:
```
User-agent: *
Allow: /

Sitemap: https://scip.io/nylon/sitemap.xml
```

**Step 5: Commit any fixes**

```bash
git add -A
git commit -m "perf: lighthouse audit fixes"
```

---

## Batch 4: Deploy Pipeline (Tasks 10–12)

### Task 10: Create GitHub Actions Deploy Workflow

**Files:**
- Create: `.github/workflows/deploy.yml`

**Why:** Automated deployment to GitHub Pages on push to main, matching the-lin project's pattern.

**Step 1: Create workflow directory**

```bash
mkdir -p /home/scipio/projects/nylon/.github/workflows
```

**Step 2: Write deploy.yml**

```yaml
name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run build
      - uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
```

**Step 3: Verify YAML is valid**

```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))"
```

**Step 4: Commit**

```bash
git add .github/
git commit -m "ci: add GitHub Actions deploy workflow for GitHub Pages"
```

---

### Task 11: Verify Production Build End-to-End

**Files:** None (verification only)

**Why:** Final sanity check before marking Phase 3 complete.

**Step 1: Clean build**

```bash
rm -rf dist node_modules/.tmp
npm run build
```

Expected: PASS, no warnings.

**Step 2: Verify dist contents**

```bash
ls -la dist/
ls dist/assets/
ls dist/favicon.svg dist/og-image.png dist/404.html
```

Expected: All assets present, HTML files present, JS/CSS chunks present.

**Step 3: Preview locally**

```bash
npm run preview
```

Manual verification checklist:
- [ ] Content Warning page loads, enter button works
- [ ] All 8 chapters visible via navigation
- [ ] CRT modals open/close with keyboard (Tab, Escape)
- [ ] Redacted text reveals on click/Enter
- [ ] BurntEdgeCards expand/collapse
- [ ] Skip-to-content link visible on Tab focus
- [ ] Navigation menu opens/closes
- [ ] Page counter appears in Ch.4

---

### Task 12: Update CLAUDE.md — Phase 3 Complete

**Files:**
- Modify: `CLAUDE.md`

**Why:** Reflect Phase 3 completion in the project status documentation.

**Step 1: Update the Project Status section**

Under `### Completed: Phase 2`, add a new section:

```markdown
### Completed: Phase 3 — Polish, Accessibility & Deploy (2026-02-20)

**HTML & SEO:**
- Proper `lang="zh-TW"`, title, description
- Open Graph and Twitter Card meta tags
- Google Fonts preconnect + stylesheet link with `display=swap`
- Custom favicon.svg

**Accessibility:**
- Skip-to-content link
- Focus trap in CRT modal overlay
- Keyboard-accessible navigation backdrop
- Auto-focus on menu open
- `aria-controls`/`aria-expanded` on BurntEdgeCard
- `aria-live` on StampAnimation
- Content Warning enter button with descriptive aria-label
- `lang="zh-TW"` on Chinese blockquotes

**Performance:**
- `font-display: swap` fallbacks
- `contain: layout style` on chapter sections
- Layout containment for scroll-snap children
- Lighthouse audit fixes

**Deploy:**
- GitHub Actions workflow (`.github/workflows/deploy.yml`)
- 404.html SPA redirect for GitHub Pages
- robots.txt
```

Under `### Not Yet Created`, update to:

```markdown
### Not Yet Created
- PixiJS procedural pixel art scenes (`src/components/pixel/`) — PNG placeholders acceptable for MVP
```

**Step 2: Verify build (CLAUDE.md is not compiled, but ensure no accidental edits)**

Run: `npm run build`
Expected: PASS

**Step 3: Commit**

```bash
git add CLAUDE.md
git commit -m "docs: update CLAUDE.md to reflect Phase 3 completion"
```

---

## Execution Summary

| Batch | Tasks | Theme | Commit Count |
|-------|-------|-------|-------------|
| 1 | 1–3 | HTML, SEO, public assets | 3 |
| 2 | 4–7 | Accessibility | 4 |
| 3 | 8–9 | Performance & fonts | 2 |
| 4 | 10–12 | Deploy pipeline & docs | 3 |
| **Total** | **12** | | **12 commits** |

**Estimated files touched:** 12 modified, 5 created
**No new npm dependencies required.**
